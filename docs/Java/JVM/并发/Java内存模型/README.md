# Java 内存模型

### 引言

> #### 缓存一致性
>
> 由于计算机的存储设备与处理器的运算速度有几个数量级的差距，所以现代计算机系统都不得不加入一层或多层读写速度尽可能接近处理器运算速度的高速缓存（Cache）来作为内存与处理器之间的缓冲。
>
> 将运算需要使用的数据复制到缓存中，让运算能快速进行，当运算结束后再从缓存同步到内存中，这样处理器就无须等待缓慢的内存读写了。
>
> ***基于高速缓存的存储交互很好的解决了 CPU 与内存之间的速度矛盾，但是也为计算机系统带来了更高的复杂度，因为它引入了一个新的问题：「缓存一致性」（Cache Coherence）。***
>
> 在多处理器系统中，每个处理器都有自己的高速缓存，而它们又共享同一主内存（Main Memory）。当多个处理器的运算任务都涉及同一块主内存区域时，将可能导致各自的缓存数据不一致，如果真的发生这种情况，那同步回到主内存时以谁的缓存为准呢？
>
> 为了解决一致性的问题，需要各个处理器访问缓存时都遵循一些协议，在读写时要根据协议来进行操作，这类协议有 MSI，MESI（Illinois Protocol），MOSI，Synapse，Firefly 及 Dragon Protocol 等。

**这里的内存模型，可以理解为在特定的操作协议下，对特定的内存或高速缓存进行读写访问的过程抽象。不同架构的物理机可以拥有不一样的内存模型，而 JVM 也有自己的内存模型。**

> #### 乱序执行
>
> 除了增加高速缓存之外，为了使处理器内部的运算单元能被充分利用，**处理器可能会对输入的代码进行乱序执行（Out-Of-Order Execution）优化**，处理器会在计算之后将乱序执行的结果重组，保证该结果与顺序执行的结果一致，但并不保证程序中各个语句计算的先后顺序与输入代码中的顺序一致，因此，如果存在一个计算任务依赖另一个计算任务的中间结果，那么其顺序性并不能靠代码的先后顺序保证。

与处理器的乱序执行优化类似，Java 虚拟机的即时编译器中也有类似的指令重排序（Instruction Reorder）优化。


### Java 内存模型

JVM 规范中试图定义一种 Java 内存模型（Java Memory Model，JMM）来屏蔽掉各种硬件和操作系统的内存访问差异，以实现让 Java 程序在各种平台下都能达到一致的内存访问效果。


#### 主内存与工作内存

**Java 内存模型的主要目标是定义程序中各种变量的访问规则，也就是在 JVM 中将变量存储到内存和从内存中取出变量这样的底层细节。**

此处的变量与 Java 程序中所说的变量有所区别，它包括了实例字段、静态字段和构成数组对象的元素；但不包括局部变量与方法参数（因为后者是线程私有的，不会被共享，自然就不会存在竞争问题。其中，如果局部变量是一个 reference 类型，它引用的对象在 Java 堆中被各个线程共享，但是 reference 本身在 Java 栈的局部变量表中，它是线程私有的）。


> Java 内存模型规定：
>
> 1. 所有的变量都存储在主内存（Main Memory）中（此处的主内存与物理硬件时的主内存名字一样，两者可以类比；但此处仅是虚拟机内存的一部分）。
> 2. 每条线程还有自己的工作内存（Working Memory，可与处理器高速缓存类比）。
> 3. **线程的工作内存中保存了被该线程使用到的变量的主内存副本拷贝，线程对变量的所有操作（读取、赋值等）都必须在工作内存中进行，而不能直接读写主内存中的变量。**
> 4. 不同的线程之间也无法直接访问对方工作内存中的变量，线程间变量值的传递均需要通过主内存来完成。

- 关于工作内存中的副本拷贝

    假设线程中访问一个 10MB 的对象，不会把这 10MB 内存复制一份。这个对象的引用、对象中某个在线程访问到的字段有可能存在拷贝，但不会有虚拟机实现成把整个对象拷贝一次。

- `volatile` 变量

    JVM 规定，就算是 `volatile` 变量，仍然有工作内存的拷贝，但是由于它特殊的操作顺序型规定，所以看起来如同直接在主内存读写访问一般，因此这里的描述对于 `volatile` 变量也并不存在例外。

- 名词含义

    这里所讲的主内存、工作内存与 Java 内存区域中的 Java 堆、栈、方法区等并不是同一个层次的内存划分，这两者基本没有关系。如果要勉强对应，从定义来看。「主内存」主要对应于 Java 堆中的对象实例数据部分，而「工作内存」则对应于虚拟机栈中的部分区域。

    从更低层次上说，主内存就直接对应与物理硬件的内存，而为了获取更好的运行速度，虚拟机可能会让「工作内存」优先存储于寄存器和高速缓存中，因为 Java 程序运行时主要访问读写的是工作内存。