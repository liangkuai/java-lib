# 线程池最佳实践


### 1. 使用 `ThreadPoolExecutor` 的构造函数创建线程池
避免使用 `Executors` 类的中的四大线程池，因为可能会有 OOM 的风险。

- `FixedThreadPool` 和 `SingleThreadExecutor` ：允许请求的队列长度为 `Integer.MAX_VALUE`，可能堆积大量的请求，从而导致 OOM。
- `CachedThreadPool` 和 `ScheduledThreadPool` ：允许创建的线程数量为 `Integer.MAX_VALUE`，可能会创建大量线程，从而导致 OOM。

也就是，**使用有界队列，控制线程创建数量。**


### 2. 正确配置线程池参数
实际使用中需要根据自己机器的性能、业务场景来手动配置线程池的参数比如核心线程数、使用的任务队列、饱和策略等等。

#### 如何确定线程池的大小？
- 如果线程池太小，可能会导致大量任务堆积在任务队列中，或者没有充分利用 CPU 资源。
- 如果线程池太大，大量线程抢占 CPU 资源，会导致大量的上下文切换，影响整体执行效率。

> #### 上下文切换
> 多线程环境下，一般线程的数量要大于 CPU 核心数，而一个 CPU 核心任意时刻只能执行一个线程，为了让所有线程都能得到执行，CPU 采用时间片轮转策略。当一个线程分配的时间片用完时，先保存当前的状态，然后重新进入就绪状态，将 CPU 执行时间让给其他线程。
>
> 每次上下文切换都需要消耗 ns 级的 CPU 时间。

##### 1. CPU 密集型任务（N+1）
这种任务消耗的主要是 CPU 资源，可以将线程数设置为 N（CPU 核心数）+1，充分利用 CPU 偶然的空闲时间，同时减少上下文切换频率。

##### 2. I/O 密集型任务（2N）
对于这种任务，经常需要阻塞线程来处理 I/O，可以多配置一些线程交替执行，一般就是 2N。


### 3. 不同类别的业务用不同的线程池
不同的业务使用不同的线程池，配置线程池的时候根据当前业务的情况，甚至根据自己机器的性能，对当前线程池进行配置，因为不同业务的并发以及对资源的使用情况都不同，重点优化系统性能瓶颈相关的业务。


### 4. 显示地给线程池命名，有助于定位问题